---
name: tdd
description: 测试驱动开发（TDD）流程助手，包含 Git 提交规范
version: 0.0.1
tags:
  - testing
  - tdd
  - workflow
  - git
dependencies:
  git: "any"
---

# TDD 编程模式（带 Git 管理）

请结合当前对话的上下文代码，严格遵循测试驱动开发（TDD）流程：

**前置：** 分析上下文，识别需要测试/开发的功能点，选择合适的测试框架

---

## TDD 开发循环

### 1. 🔴 红 - 编写失败的测试
- 为功能编写测试代码
- 运行测试确认失败
- **Git 提交：** `git commit -m "test: 添加 xxx 功能的失败测试"`

### 2. 🟢 绿 - 编写最少代码使测试通过
- 编写最少量的实现代码
- 运行测试确认通过
- **Git 提交：** `git commit -m "feat: 实现使测试通过的 xxx 功能"`

### 3. ♻️ 重构 - 在测试保护下优化代码
- 优化代码结构和实现
- 运行测试确保未破坏
- **Git 提交：** `git commit -m "refactor: 重构 xxx 功能代码"`

---

## 测试规范

```
1. 【文件组织】tests/{unit,integration,e2e}/ 与源码目录镜像对应
2. 【命名规范】test_<功能>_<条件>_<期望>，如 test_login_invalid_return_401
3. 【结构规范】遵循 AAA 模式：Arrange（准备）→ Act（执行）→ Assert（断言）
4. 【单一职责】一个测试只验证一个行为，不超过20行，断言不超过5个
5. 【测试金字塔】单元测试70% / 集成测试20% / E2E测试10%
6. 【Mock规则】仅隔离外部依赖（API/数据库/文件系统），纯函数无需Mock
7. 【断言规范】使用精确断言，失败消息应自解释：assert result == expected, "原因"
8. 【数据管理】使用 fixtures/Builder 模式，避免硬编码重复数据
9. 【覆盖率要求】核心逻辑≥80%，整体≥70%，关键路径100%
10. 【异常测试】必须覆盖空值/边界/异常场景，使用 pytest.raises() 验证
11. 【自查清单】命名/AAA结构/单一职责/Mock正确/覆盖边界/覆盖率达标
```

**核心原则：** 测试即文档，代码应自解释；宁可少测不可测错。

---

## 遗留代码处理

对已有代码：
1. 先补充测试（测试先行重构）
2. 运行测试确认通过
3. 再进行修改
4. **Git 提交：** 使用 `refactor` 或 `test` 前缀

---

## Git 提交规范

| 阶段 | 前缀 | 示例 |
|------|------|------|
| 红（测试） | `test:` | `test: 添加用户登录的失败测试` |
| 绿（实现） | `feat:` | `feat: 实现用户登录功能` |
| 重构 | `refactor:` | `refactor: 优化登录验证逻辑` |

**每次 TDD 循环完成后，应完成一个完整的 Git 提交组**

---

## 状态报告

**每步完成后报告：**
1. 当前状态（红/绿/重构）
2. 测试运行结果
3. Git 提交信息
4. 下一步计划
