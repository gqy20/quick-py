name: 测试 Copier 模板

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-template:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
        with-api: [true, false]
        with-cli: [true, false]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: 安装 uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: 安装 copier
        run: |
          uv pip install copier

      - name: 使用 copier 生成项目
        run: |
          copier copy . /tmp/test-project \
            --data project_name="Test Project" \
            --data package_name="test_package" \
            --data author_name="Test Author" \
            --data author_email="test@example.com" \
            --data description="A test project" \
            --data version="0.1.0" \
            --data python_version="${{ matrix.python-version }}" \
            --data license="MIT" \
            --data add_api=${{ matrix.with-api }} \
            --data add_cli=${{ matrix.with-cli }} \
            --data line_length=88 \
            --defaults

      - name: 进入项目目录并安装依赖
        working-directory: /tmp/test-project
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: 运行代码检查
        working-directory: /tmp/test-project
        run: |
          source .venv/bin/activate
          ruff check .
          ruff format --check .

      - name: 运行测试
        working-directory: /tmp/test-project
        run: |
          source .venv/bin/activate
          pytest --cov=src/test_package --cov-report=xml --cov-report=term-missing

      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v4
        with:
          files: /tmp/test-project/coverage.xml
          flags: template-${{ matrix.python-version }}-api-${{ matrix.with-api }}-cli-${{ matrix.with-cli }}
          name: Python ${{ matrix.python-version }} (API: ${{ matrix.with-api }}, CLI: ${{ matrix.with-cli }})
          fail_ci_if_error: false
