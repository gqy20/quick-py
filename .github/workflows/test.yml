name: 测试 Copier 模板

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # 设置 uv 缓存目录，避免权限问题
  UV_CACHE_DIR: ${{ github.workspace }}/.cache/uv

jobs:
  test-template:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.13']
        with-api: [true]
        with-cli: [false]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: 安装 uv 和 copier
        run: |
          # 安装 uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # 安装 copier 到当前 Python 环境
          python -m pip install copier

      - name: 配置 uv 缓存
        run: |
          mkdir -p ${{ env.UV_CACHE_DIR }}
          echo "UV_CACHE_DIR=${{ env.UV_CACHE_DIR }}" >> $GITHUB_ENV

      - name: 使用 copier 生成项目
        run: |
          # 确保 uv 在 PATH 中
          export PATH="$HOME/.cargo/bin:$PATH"
          # 使用 --defaults 跳过交互式提示
          copier copy --vcs-ref HEAD . /tmp/test-project \
            --data project_name="Test Project" \
            --data package_name="test_package" \
            --data author_name="Test Author" \
            --data author_email="test@example.com" \
            --data description="A test project" \
            --data version="0.1.0" \
            --data python_version="${{ matrix.python-version }}" \
            --data license="MIT" \
            --data add_api=${{ matrix.with-api }} \
            --data add_cli=${{ matrix.with-cli }} \
            --data line_length=88 \
            --defaults

      - name: 验证生成的项目结构
        run: |
          ls -la /tmp/test-project
          test -f /tmp/test-project/pyproject.toml
          test -d /tmp/test-project/src

      - name: 创建虚拟环境并安装依赖
        working-directory: /tmp/test-project
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv venv
          uv pip install -e ".[dev]"

      - name: 运行代码检查
        working-directory: /tmp/test-project
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run ruff check .
          uv run ruff format --check .

      - name: 运行测试
        working-directory: /tmp/test-project
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run pytest --cov=src/test_package --cov-report=xml --cov-report=term-missing -v

      - name: 检查覆盖率
        working-directory: /tmp/test-project
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run pytest --cov=src/test_package --cov-report=term-missing --cov-fail-under=50
